name: Build Book

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'templates/**'
      - '.github/workflows/build-book.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      scheme:
        description: 'Pronunciation scheme to use'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cla
          - koi1
          - koi2
          - byz1
          - byz2

jobs:
  # Job to determine which schemes to build
  determine-schemes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.scheme }}" == "all" || "${{ github.event.inputs.scheme }}" == "" || "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "matrix={\"scheme\":[\"cla\",\"koi1\",\"koi2\",\"byz1\",\"byz2\"]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"scheme\":[\"${{ github.event.inputs.scheme }}\"]}" >> $GITHUB_OUTPUT
          fi

  # Main build job
  build:
    needs: determine-schemes
    runs-on: ubuntu-latest

    strategy:
      matrix: ${{ fromJson(needs.determine-schemes.outputs.matrix) }}
      fail-fast: false

    env:
      SCHEME_NAME: ${{ matrix.scheme == 'cla' && 'Classical' || matrix.scheme == 'koi1' && 'Early Koine' || matrix.scheme == 'koi2' && 'Late Koine' || matrix.scheme == 'byz1' && 'Middle Byzantine' || matrix.scheme == 'byz2' && 'Late Byzantine' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Lua
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.3
          sudo ln -sf /usr/bin/lua5.3 /usr/bin/lua

      - name: Install Pandoc
        run: |
          sudo apt-get install -y pandoc

      - name: Install LaTeX
        run: |
          sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-fonts-extra

      - name: Install PDF tools
        run: |
          sudo apt-get install -y ghostscript pdftk poppler-utils

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install argparse

      - name: Build PDF
        run: |
          bash scripts/pdf_pron.sh --scheme ${{ matrix.scheme }}
          mv docs/lgpsi_pron.pdf docs/lgpsi_${{ matrix.scheme }}.pdf

      - name: Build HTML
        run: |
          bash scripts/html_pron.sh --scheme ${{ matrix.scheme }}

      - name: Build EPUB
        run: |
          bash scripts/ebook_pron.sh --scheme ${{ matrix.scheme }}
          mv docs/lgpsi_pron.epub docs/lgpsi_${{ matrix.scheme }}.epub

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: lgpsi-${{ matrix.scheme }}-pdf
          path: docs/lgpsi_${{ matrix.scheme }}.pdf
          retention-days: 7

      - name: Upload EPUB artifact
        uses: actions/upload-artifact@v4
        with:
          name: lgpsi-${{ matrix.scheme }}-epub
          path: docs/lgpsi_${{ matrix.scheme }}.epub
          retention-days: 7

      - name: Prepare HTML artifacts
        run: |
          # Create a directory for HTML files with CSS and fonts
          mkdir -p html_output
          # Copy HTML files
          cp docs/*.html html_output/
          # Copy CSS file
          cp docs/style_pron.css html_output/
          # Copy font files
          cp docs/*.ttf html_output/
          echo "HTML files prepared with CSS and fonts"

      - name: Upload HTML artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lgpsi-${{ matrix.scheme }}-html
          path: html_output/
          retention-days: 7

      - name: Summary
        run: |
          echo "## Build Summary for ${{ env.SCHEME_NAME }} (${{ matrix.scheme }}) Pronunciation" >> $GITHUB_STEP_SUMMARY
          echo "✅ PDF: lgpsi_${{ matrix.scheme }}.pdf" >> $GITHUB_STEP_SUMMARY
          echo "✅ EPUB: lgpsi_${{ matrix.scheme }}.epub" >> $GITHUB_STEP_SUMMARY
          echo "✅ HTML files: Generated with CSS and font files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts from the GitHub Actions run to access these files." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note for HTML files**: The HTML artifact includes:" >> $GITHUB_STEP_SUMMARY
          echo "- HTML files with pronunciation" >> $GITHUB_STEP_SUMMARY
          echo "- style_pron.css stylesheet" >> $GITHUB_STEP_SUMMARY
          echo "- Required font files (NotoSansDisplay_Condensed-Regular.ttf and SBLGreek.ttf)" >> $GITHUB_STEP_SUMMARY


